name: Node JS Common Docker CI template
on:
  workflow_call:
    inputs:
      ASSET_ID:
        description: 'Asset ID'
        type: string
        required: true
      NODE_VERSION:
        description: 'Node Version to use'
        type: string
        default: "16"
        required: false
      
      BUILD_COMMANDS:
        description: 'Build commands to use'
        type: string
        default: "['rm .npmrc','npm install','npm run build']"
        required: false
      ENABLE_NPMRC_UPDATE:
        description: 'Enable .npmrc file update for npm projects in gradle. Generally for UI projects'
        type: boolean
        default: false
        required: false
     
     #ARTIFACORY DETAILS
      ARTIFACTORY_DEFAULT_BRANCH:
        description: 'TR jfrog branch name to use. If Blank, no branching strategy is applied'
        type: string
        default: "develop"
        required: false
        
     #SONARQUBE DETAILS
      SONAR_HOST_URL:
        description: 'The sonarqube host URL'
        type: string
        default: "https://sonar.prod.thomsonreuters.com/"
        required: false
      SONARQUBE_PROJECTKEY:
        description: 'Sonarqube Project Key. If present then only sonarqube scan occurs.'
        type: string
        default: ""
        required: false
      ENABLE_SONARQUBE_GATE:
        description: 'Enable Sonarqube gate. Only works if SONARQUBE_PROJECTKEY parameter is provided.'
        type: boolean
        default: true
        required: false
      ENABLE_SONARQUBE_DEVOPS_INTEGRATION:
        description: 'Enable Sonarqube Devops Integration. Only works if SONARQUBE_PROJECTKEY parameter is provided.'
        type: boolean
        default: true
        required: false        
      
      #SNYK DETAILS
      SNYK_ORG:
        description: 'Snyk organization ID'
        type: string
        default: ""
        required: false
      SNYK_EXCLUDE_FOLDERS:
        description: 'comma(,) separated folder names to exclude from SNYK scan'
        type: string
        default: "docker"
        required: false
        
      #DOCKER DETAILS
      DOCKER_FILE:
        description: 'Docker File Location'
        type: string
        default: ""
        required: false
      ARTIFACTORY_DOCKER_HOST:
        description: 'TR jfrog host'
        type: string
        default: "tr1-docker-local.jfrog.io"
        required: false
      ARTIFACTORY_DOCKER_REPO:
        description: 'TR jfrog docker repo name. Works Only if DOCKER_FILE is provided'
        type: string
        default: ""
        required: false
      DOCKER_BUILD_WITH_SECRETS:
        description: 'Pass artifactory credentials as secrets to Docker build. Works Only if DOCKER_FILE is provided'
        type: boolean
        default: false
        required: false
      DOCKER_BUILD_ARGS:
        description: 'Build arguments to pass to Docker build. Works Only if DOCKER_FILE is provided'
        type: string
        default: ""
        required: false

      #SYSDIG DETAILS
      ENABLE_SYSDIG:
        description: 'Enable Sysdig. Works Only if DOCKER_FILE is provided'
        type: boolean
        default: false
        required: false
        
      # BRANCH DETAILS
      MAIN_BRANCH:
        description: 'Main Branch'
        type: string
        default: ""
        required: false
      TRIGGER_BRANCH:
        description: 'Trigger Branch'
        type: string
        default: ""
        required: false
      RELEASE_BRANCH_PREFIX:
        description: 'Release Branch Prefix'
        type: string
        default: "release"
        required: false
      
      # NOTIFICATION DETAILS
      MSTEAMS_WEBHOOK:
        description: 'MS Teams Webhook'
        type: string
        default: ""
        required: false    
      
      #Outputs
      ACTION_INFO_FILE_NAME:
        description: 'Action info File Name'
        type: string
        default: "action-info.json"
        required: false
      
        
    secrets:
      ARTIFACTORY_USERNAME:
        required: true
      ARTIFACTORY_PASSWORD:
        required: true
      SONAR_TOKEN:
        required: true
      SNYK_TOKEN:
        required: true
      SYSDIG_TOKEN:
        required: false

env:
  DOCKER_FILE: ${{inputs.DOCKER_FILE}}
  TR_ARTIFACTORY_URL: "https://tr1.jfrog.io/artifactory"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - 
      name: Check out
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - 
      name: Get Datetime
      id: time
      uses: nanzm/get-time-action@v1.1
      with:
        timeZone: 0
        format: 'YYYY-MM-DD-HH-mm-ss'
    - name: Installing Snyk
      run: npm install snyk -g
    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: ${{ inputs.NODE_VERSION }}
        registry-url: https://tr1.jfrog.io/artifactory/api/npm/npm/
             
    - name: Setup ENV Variables
      shell: sh
      run: |
        echo "CURRENT_BRANCH=$(git branch --show-current | tr '.' '_' | tr '#' '_')" >> $GITHUB_ENV
        if [ ${{ inputs.MAIN_BRANCH }} != '' ]; then
            MAIN_BRANCH_REF=refs/heads/${{inputs.MAIN_BRANCH}}
        else
            MAIN_BRANCH_REF=refs/heads/${{github.event.repository.default_branch}}
        fi
        echo "MAIN_BRANCH_REF=$MAIN_BRANCH_REF" >> $GITHUB_ENV
        JFROG_BRANCH=''
        JFROG_PATH=''
        if [ ${{ inputs.ARTIFACTORY_DEFAULT_BRANCH }} != '' ]; then
            case "${{ github.ref_name }}" in
              ("${{inputs.RELEASE_BRANCH_PREFIX}}"*)
                JFROG_BRANCH=release                
                ;;
              (*)
                JFROG_BRANCH=${{ inputs.ARTIFACTORY_DEFAULT_BRANCH }}
                ;;
            esac
            JFROG_PATH=/$JFROG_BRANCH
        fi
        echo "Variable JFROG_PATH set to $JFROG_PATH"      
        echo "JFROG_BRANCH=$JFROG_BRANCH" >> $GITHUB_ENV              
        if [ ${{ inputs.ARTIFACTORY_DOCKER_REPO }} != '' ]; then
              echo "ARTIFACTORY_DOCKER_REPO=${{inputs.ARTIFACTORY_DOCKER_REPO}}$JFROG_PATH" >> $GITHUB_ENV
              echo "ARTIFACTORY_FULL_DOCKER_REPO=${{inputs.ASSET_ID}}/${{inputs.ARTIFACTORY_DOCKER_REPO}}$JFROG_PATH" >> $GITHUB_ENV              
        fi
        
    - name: Print ENV Variables
      shell: sh
      run: |
          echo "Env Variable CURRENT_BRANCH set to ${{ env.CURRENT_BRANCH }}"
          echo "Env Variable MAIN_BRANCH_REF set to ${{ env.MAIN_BRANCH_REF }}"
          echo "Env Variable JFROG_BRANCH set to ${{ env.JFROG_BRANCH }}"
          echo "Env Variable ARTIFACTORY_DOCKER_REPO set to ${{ env.ARTIFACTORY_DOCKER_REPO }}"
          echo "Env Variable ARTIFACTORY_FULL_DOCKER_REPO set to ${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}"

    - 
      name: Update NPMRC file
      if: contains(fromJSON('["push", "pull_request"]'), github.event_name) && inputs.ENABLE_NPMRC_UPDATE
      run: |
        basevalue=$(echo -n "${{ secrets.ARTIFACTORY_USERNAME }}:${{ secrets.ARTIFACTORY_PASSWORD }}" | base64 -w 0)
        all_nprmc_files=$(find ./ -type f -name '.npmrc')
        for file in $all_nprmc_files
        do 
          echo $file
          sed -i -E "s|.*_auth.*||g" $file
          echo -e $"\n//tr1.jfrog.io/tr1/api/npm/:_auth=$basevalue" >> $file
          cat $file
        done
    -
      name: Build Source Code
      run: |
        BUILD_COMMANDS=$(echo "${{ inputs.BUILD_COMMANDS }}" | sed "s/'/\"/g" | jq -c .)        
        echo $BUILD_COMMANDS
        for row in $(echo "${BUILD_COMMANDS}" | jq -r '.[] | @base64'); do
           _jq() {
             echo ${row} | base64 --decode
            }
            $(_jq)
        done
        echo "### Build Finished! :rocket:" >> $GITHUB_STEP_SUMMARY
      env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
    -
      name: Generate Action Info
      run: |                
        actionInfoJson=$( jq -n --arg tag "${{ github.sha }}" '{tag: $tag,artifact:null,dockerimage:null}')        
        
        ACTION_INFO_FILE=${{ inputs.ACTION_INFO_FILE_NAME}}
        
        echo $actionInfoJson | jq > $ACTION_INFO_FILE
        
        if [ ${{ env.DOCKER_FILE }} != '' ]; then
            docker_image=${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}
            actionInfoJson=$(jq  --arg docker_image "$docker_image" '.dockerimage |= $docker_image' $ACTION_INFO_FILE)
            echo $actionInfoJson | jq > $ACTION_INFO_FILE
        fi        
        cat $ACTION_INFO_FILE
    - 
      name: SonarQube Scan
      if: contains(fromJSON('["push", "pull_request"]'), github.event_name) && inputs.SONARQUBE_PROJECTKEY!=''
      uses: sonarsource/sonarqube-scan-action@v2.0.2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{inputs.SONAR_HOST_URL}}
      with:
        args: >
          -Dsonar.projectVersion=${{ github.sha }}
          -Dsonar.verbose=false
          -Dsonar.projectKey=${{ inputs.SONARQUBE_PROJECTKEY }}
    - 
      name: SonarQube Quality Gate
      if: contains(fromJSON('["push", "pull_request"]'), github.event_name) && inputs.SONARQUBE_PROJECTKEY!='' && inputs.ENABLE_SONARQUBE_GATE
      id: sonarqube-quality-gate-check
      uses: sonarsource/sonarqube-quality-gate-action@master
      timeout-minutes: 5
      env:
       SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
       SONAR_HOST_URL: ${{inputs.SONAR_HOST_URL}}
    
    -
      name: SonarQube DevOps Integration
      continue-on-error: true
      if: contains(fromJSON('["push", "pull_request"]'), github.event_name) && inputs.SONARQUBE_PROJECTKEY!='' && inputs.ENABLE_SONARQUBE_DEVOPS_INTEGRATION
      shell: sh
      run: |
        echo ${{ github.event.repository.name }}
        curl --silent --show-error --fail -u ${{ secrets.SONAR_TOKEN }}: -X POST -H "Accept: application/json" -H "Content-Type: application/x-www-form-urlencoded" "${{inputs.SONAR_HOST_URL}}api/alm_settings/set_github_binding?almSetting=labs-devops&project=${{ inputs.SONARQUBE_PROJECTKEY }}&repository=tr%2F${{ github.event.repository.name }}&summaryCommentEnabled=true&monorepo=false"
       
    -
      name: Snyk Static Code Scan
      continue-on-error: true
      if: contains(fromJSON('["push"]'), github.event_name) && inputs.SNYK_ORG!=''
      run: |
        REPO_NAME=$(basename -s .git $(git config --get remote.origin.url))
        echo "Running static code scan for repo: "$REPO_NAME
        snyk code test --report --project-name="tr/$REPO_NAME" --severity-threshold=low --org=${{ inputs.SNYK_ORG }} --target-reference="${{ env.CURRENT_BRANCH }}"
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

    -
      name: Snyk Open Source Scan
      continue-on-error: true
      if: contains(fromJSON('["push"]'), github.event_name) && inputs.SNYK_ORG!=''
      run: |
        snyk monitor -d --all-projects  --strict-out-of-sync=false --org=${{ inputs.SNYK_ORG }} --exclude=${{ inputs.SNYK_EXCLUDE_FOLDERS }} --target-reference="${{ env.CURRENT_BRANCH }}" -- -PtrArtifactoryUser=${{ secrets.ARTIFACTORY_USERNAME }} -PtrArtifactoryPassword=${{ secrets.ARTIFACTORY_PASSWORD }}
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
    -
      name: Build Docker Image
      if: env.DOCKER_FILE!='' && contains(fromJSON('["push"]'), github.event_name) && inputs.ENABLE_SYSDIG
      run: docker build . --file ${{ env.DOCKER_FILE }} --tag ${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:${{ github.sha }}    
    - 
      name: Sysdig Scan
      if: env.DOCKER_FILE!='' && contains(fromJSON('["push"]'), github.event_name) && inputs.ENABLE_SYSDIG
      id: scan
      uses: sysdiglabs/scan-action@v3
      with:
        image-tag: "${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:${{ github.sha }}"
        sysdig-secure-url: https://us2.app.sysdig.com
        sysdig-secure-token: ${{ secrets.SYSDIG_TOKEN }}
        input-type: docker-daemon
        run-as-user: root
    -
      name: Login to TR Jfrog
      if: env.DOCKER_FILE!='' && contains(fromJSON('["push"]'), github.event_name)
      uses: docker/login-action@v2
      with:
        registry: ${{inputs.ARTIFACTORY_DOCKER_HOST}}
        username: ${{ secrets.ARTIFACTORY_USERNAME }}
        password: ${{ secrets.ARTIFACTORY_PASSWORD }}
    -
      name: Push Docker Image
      if: env.DOCKER_FILE!='' && contains(fromJSON('["push"]'), github.event_name) && !inputs.DOCKER_BUILD_WITH_SECRETS
      uses: docker/build-push-action@v3
      with:
        context: .
        file: ${{ env.DOCKER_FILE }}
        push: true
        tags: ${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:${{ github.sha }},${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:latest
        build-args: ${{ inputs.DOCKER_BUILD_ARGS }}
    -
      name: Push Docker Image (pass artifactory credentials)
      if: env.DOCKER_FILE!='' && contains(fromJSON('["push"]'), github.event_name) && inputs.DOCKER_BUILD_WITH_SECRETS
      uses: docker/build-push-action@v6
      with:
        context: .
        file: ${{ env.DOCKER_FILE }}
        push: true
        tags: ${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:${{ github.sha }},${{inputs.ARTIFACTORY_DOCKER_HOST}}/${{ env.ARTIFACTORY_FULL_DOCKER_REPO }}:latest
        build-args: ${{ inputs.DOCKER_BUILD_ARGS }}
        secrets: |
          artifactory_username=${{ secrets.ARTIFACTORY_USERNAME }}
          artifactory_password=${{ secrets.ARTIFACTORY_PASSWORD }}

    -
      name: Save Current SHA
      if: contains(fromJSON('["push"]'), github.event_name)
      run: |
        mkdir -p sha
        echo ${{ github.sha }} > sha/git-commit.txt
        cp ${{ inputs.ACTION_INFO_FILE_NAME}} sha
        CODEOWNER_FILE=.github/CODEOWNERS
        if test -f $CODEOWNER_FILE; then
          mkdir -p sha/.github
          cp $CODEOWNER_FILE sha/.github
        else
          echo "No code owner file exists"
        fi
    - 
      name: Commit Current SHA
      continue-on-error: true
      if: contains(fromJSON('["push"]'), github.event_name)
      shell: bash
      run: |
          echo $REPO_NAME,$BRANCH,$DIRECTORY_TO_PUSH,$GITHUB_SHA
          curl -L \
            -H "Accept: application/vnd.github.v3.raw" \
            -H "Authorization: Bearer ${IDT_GITHUB_READONLY_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/tr/a208767_osia-cnf-cicd-workflows/contents/src/integration/publish-subdir.sh > publish-subdir.sh
          chmod +x publish-subdir.sh
          sed -i 's/\r$//' publish-subdir.sh
          bash ./publish-subdir.sh
      env:
        GH_TOKEN: ${{ github.token }}
        IDT_GITHUB_READONLY_TOKEN: ${{ secrets.IDT_GITHUB_READONLY_TOKEN }}
        REPO_NAME: "tr/${{ github.event.repository.name }}"
        BRANCH: ${{ inputs.TRIGGER_BRANCH }}
        DIRECTORY_TO_PUSH: "sha"
        GITHUB_SHA: ${{ github.sha }}
    - 
      name: Microsoft Teams Notification
      if: inputs.MSTEAMS_WEBHOOK!='' && always()
      uses: skitionek/notify-microsoft-teams@master
      with:
          webhook_url: ${{ inputs.MSTEAMS_WEBHOOK }}
          needs: ${{ toJson(needs) }}
          job: ${{ toJson(job) }}
          steps: ${{ toJson(steps) }}
    
    -
      name: Generate Job summary
      if: github.event_name == 'push'
      run: |
        actionFile=${{ inputs.ACTION_INFO_FILE_NAME}}        
        if test -f $actionFile; 
        then
            tag=$(cat $actionFile| jq -r '.tag? //empty')            
            artifact_location=$(cat $actionFile| jq -r '.artifact.location? //empty')
            artifact_filetype=$(cat $actionFile| jq -r '.artifact.filetype? //empty')
            dockerimage=$(cat $actionFile| jq -r '.dockerimage? //empty')
            
            echo "# Action Summary" >> $GITHUB_STEP_SUMMARY
            echo "### Commit ID: $tag" >> $GITHUB_STEP_SUMMARY            
            [ ! -z $jfrogdockerrepo ] && echo "### Jfrog Docker Repo: $jfrogdockerrepo" >> $GITHUB_STEP_SUMMARY
            if [ ! -z $artifact_location ]; then
                echo "## Published Artifact" >> $GITHUB_STEP_SUMMARY
                echo "### Location: $artifact_location" >> $GITHUB_STEP_SUMMARY
                echo "### File Type: $artifact_filetype" >> $GITHUB_STEP_SUMMARY
            fi 
            if [ ! -z $dockerimage ]; then
              echo "### Docker Image: $dockerimage" >> $GITHUB_STEP_SUMMARY
            fi
        fi
